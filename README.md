# PortoAPI

Многофункциональная платформа для приема криптоплатежей через Telegram-бота и API с поддержкой TRON, xPub, учёта покупателей и инвойсов.

## Архитектура

- **src/api/** — REST API (FastAPI), эндпоинты для инвойсов, вебхуков и регистрации.
- **src/bot/** — Telegram-бот на aiogram, FSM для создания инвойсов, обработка команд продавца, автоматическое управление аккаунтами и покупателями.
- **src/core/** — бизнес-логика: HD Wallet, работа с БД (SQLAlchemy), сервисы газа и уведомлений.
- **src/services/** — keeper-бот для мониторинга блокчейна и автоматизации выплат.
- **src/static_web/** — offline-страницы для генерации xPub, безопасной настройки кошелька.

## Основные возможности

- Генерация и хранение xPub для TRON (BIP44, m/44'/195'/account').
- Автоматическое назначение следующего свободного account при добавлении нового покупателя (buyer_id).
- Учёт инвойсов по покупателям (buyer_id) у каждого продавца (seller_id), account=0 всегда для default buyer.
- Сортировка списка покупателей по номеру аккаунта.
- Подсказка продавцу, какой account использовать при генерации xPub для нового покупателя.
- Возможность полностью сменить кошелёк покупателя, используя новый master wallet с новой seed-фразой (новый xPub).
- Автоматическая активация адресов и делегирование ресурсов (ENERGY/BANDWIDTH).
- Динамическая оценка BANDWIDTH на 1 TRX по chain parameters с безопасным fallback.
- Устойчивое подтверждение транзакций (мульти-эндпоинт опрос: full/solidity, локально/удалённо).
- Улучшенная диагностика: логирование оценки BANDWIDTH и состояний ресурсов до/после.
- Ограниченный режим ⛽️ Free Gas: быстрая активация и пополнение ресурсов для одной транзакции USDT (до 3 раз на продавца).
- Keeper-бот: мониторинг статуса инвойсов, автоматизация выплат.
- Безопасная регистрация через offline-страницу (setup.html/xpub_offline.html).
- Кнопочное главное меню и все основные действия через кнопки.
- Подробная команда /help с объяснением wallet/account/address index.
- Список инвойсов с отображением derivation path и всех деталей.
- FSM автоматически сбрасывается при вводе основной команды.

## Быстрый старт

### 1. Установите зависимости

```bash
pip install -r src/requirements.txt
```

### 2. Настройте конфигурацию

```bash
# Скопируйте пример конфигурации
cp .env.example .env

# Отредактируйте .env файл с вашими настройками:
# - TELEGRAM_BOT_TOKEN (получите у @BotFather)
# - TRON_NETWORK (mainnet или testnet)
# - GAS_STATION_TYPE (single или multisig)
# - GAS_WALLET_PRIVATE_KEY или GAS_WALLET_MNEMONIC
```

### 3. Создайте директорию для базы данных

```bash
mkdir -p data
```

### 4. Проверьте конфигурацию

```bash
python scripts/validate_config.py
```

### 5. Запустите сервисы

#### Telegram-бот

```bash
python scripts/start.py bot
# или классический способ:
python -m src.bot.main_bot
```

#### API сервер

```bash
python scripts/start.py api
# или:
uvicorn src.api.v1.main:app --reload
```

#### Keeper-бот (мониторинг блокчейна)

```bash
python scripts/start.py keeper
# или:
python -m src.services.keeper_bot
```

### (Опционально) Включите локальный pre-commit hook

В репозитории есть локальный pre-commit hook, блокирующий секреты и крупные файлы (>5MB).

```bash
chmod +x .git-hooks/pre-commit
git config core.hooksPath .git-hooks
```

Подробнее: см. файл .hooks-README.md

### Keeper Bot: Настройка очереди активации

Очередь активации адресов (делегирование ресурсов/активация) настраивается через переменные окружения:

```env
# Количество фоновых воркеров очереди активации (1-2 обычно достаточно)
KEEPER_ACTIVATION_QUEUE_WORKERS=1

# Запуск задач очереди синхронно (true) или в фоне (false)
# В проде используйте false; в тестах/CI можно включить true для детерминированности
KEEPER_ACTIVATION_QUEUE_SYNC=false

# Количество повторных попыток при ошибках активации
KEEPER_ACTIVATION_QUEUE_RETRIES=3

# Пауза между попытками (сек.)
KEEPER_ACTIVATION_QUEUE_BACKOFF_SEC=5.0
```

#### Рекомендации

- Прод: оставьте `KEEPER_ACTIVATION_QUEUE_SYNC=false`, 1-2 воркера, 3 ретрая, 5 сек. бэкофф.
- Тесты/CI: установите `KEEPER_ACTIVATION_QUEUE_SYNC=true` для синхронной обработки.

## Конфигурация

### Сеть TRON

Система поддерживает как mainnet, так и testnet TRON:

- **Testnet**: Для разработки и тестирования
- **Mainnet**: Для продакшена

### Gas Station (Активация адресов)

#### Режим Single Wallet

Использует один кошелек для всех операций активации:

```env
GAS_STATION_TYPE=single
GAS_WALLET_PRIVATE_KEY=your_private_key
# или
GAS_WALLET_MNEMONIC=your mnemonic phrase here
```

#### Режим Multisig (планируется)

Использует мультиподписной контракт:

```env
GAS_STATION_TYPE=multisig
MULTISIG_CONTRACT_ADDRESS=TMultiSigAddress
MULTISIG_REQUIRED_SIGNATURES=2
MULTISIG_OWNER_KEYS=key1,key2,key3
```

### Настройка ресурсов

Контролируйте количество TRX для операций:

```env
AUTO_ACTIVATION_TRX_AMOUNT=1.5    # Активация адреса
ENERGY_DELEGATION_TRX_AMOUNT=1.1  # Делегирование ENERGY  
BANDWIDTH_DELEGATION_TRX_AMOUNT=1.0 # Делегирование BANDWIDTH

# Целевые пороги ресурсов (для стабильной USDT-транзакции)
TARGET_ENERGY_UNITS=90000
TARGET_BANDWIDTH_UNITS=1000

# Оценки эффективности (юнитов на 1 TRX). Используются как fallback,
# а основное значение для BANDWIDTH вычисляется динамически по chain params.
ENERGY_UNITS_PER_TRX_ESTIMATE=300
BANDWIDTH_UNITS_PER_TRX_ESTIMATE=1500

# Оценка затрат на перевод 1 USDT (TRC20); тестовая сеть Nile ≈ 14650/345
USDT_ENERGY_PER_TRANSFER_ESTIMATE=14650
USDT_BANDWIDTH_PER_TRANSFER_ESTIMATE=345

# Поведение делегации
DELEGATION_SAFETY_MULTIPLIER=1.1
MIN_DELEGATE_TRX=1.0
# Режим активации аккаунта: 'transfer' или 'create_account'
GAS_ACCOUNT_ACTIVATION_MODE=transfer
```

## Настройка кошелька продавца

- Перейдите на `/src/static_web/setup.html` или используйте `xpub_offline.html` для генерации xPub.
- Следуйте инструкциям на странице, сохраните seed-фразу, подтвердите и отправьте xPub на сервер.
- Для каждого нового покупателя используйте новый account (номер будет показан ботом при добавлении).
- Для полной смены кошелька покупателя используйте новый master wallet с новой seed-фразой и новый xPub.

## Структура БД (основное)

- sellers: telegram_id, ...
- buyers: id, seller_id, buyer_id, account, xpub
- invoices: id, seller_id, buyer_id, ...
- wallets: id, telegram_id, buyer_id, account, xpub

## Безопасность

- Все операции с seed/xPub выполняются на клиенте (offline-страницы).
- Приватные ключи не передаются на сервер.
- Для предотвращения утечек секретов используйте локальный pre-commit hook (.git-hooks). Инструкция в .hooks-README.md.

## Принципы работы TRON-клиента и динамического BANDWIDTH

- Если включены локальные ноды (TRON_LOCAL_NODE_ENABLED=true), приоритет отдается им; при недоступности используется удалённый fallback (Trongrid/Nile).
- Для оценки эффективности BANDWIDTH модуль получает chain parameters (totalNetLimit/totalNetWeight) и вычисляет «юнитов на 1 TRX». При недоступности параметров используется значение из ENV (BANDWIDTH_UNITS_PER_TRX_ESTIMATE).
- Подтверждение транзакций и чтение ресурсов выполняется с нескольких точек (wallet и walletsolidity, локальные/удалённые) с выбором наилучшего наблюдаемого состояния.

## ⛽ Free Gas: быстрая активация и пополнение ресурсов

Команда /free_gas в боте активирует указанный TRON-адрес (T...) и делегирует минимальные ресурсы для одной транзакции USDT.

- Лимит: до 3 использований на одного продавца.
- Строгая валидация адреса (Base58Check + префикс 0x41).
- Прежде чем пополнять, бот показывает «Перед: ... Energy/BW», а по завершении — «После: ...»; значения берутся с нескольких узлов и консистентно агрегируются.
- Если адрес уже имеет достаточно ресурсов, бот спросит подтверждение для дополнительного пополнения.

Чтобы воспользоваться: откройте бот → команда «⛽️ Free Gas ⛽️» или /free_gas → отправьте адрес T...

## Взаимодействие с Telegram-ботом

### Основные команды

- `/start` — Приветствие и главное меню с кнопками.
- `/help` — Список доступных команд и подробные объяснения wallet/account/address index.
- `/register` — Регистрация продавца, генерация токена и ссылки для настройки кошелька.
- `/deposit` — Показать баланс газового депозита продавца.
- `/balance` — Показать общий баланс продавца.
- `/create_invoice` — Пошаговое создание инвойса (через FSM: сумма, описание, выбор покупателя).
- `/sweep` — Обработка всех оплаченных инвойсов, активация адресов, вывод средств.
- `/buyers` — Список всех покупателей продавца, отсортирован по account.
- `/add_buyer` — Добавить нового покупателя для отдельного учета инвойсов, бот подскажет account.

#### Покупатели

Бот поддерживает создание покупателей (`buyer_id`) у каждого продавца (`seller_id`).
Это позволяет вести раздельный учёт поступлений и адресов для разных клиентов:

1. Используйте `/add_buyer` для создания нового покупателя (например, для постоянного клиента или сегмента). Бот покажет account для xPub.
2. При создании инвойса через `/create_invoice` выберите нужного покупателя.
3. Все адреса и поступления будут связаны с выбранным покупателем.
4. Для просмотра покупателей используйте `/buyers`.

Для полной смены кошелька покупателя используйте новый master wallet с новой seed-фразой и новый xPub.

### Как работать с ботом

1. Напишите `/start` — получите меню и инструкции.
2. Выполните `/register` — получите ссылку для настройки кошелька (setup.html).
3. После настройки кошелька используйте `/add_buyer` для создания покупателя (бот подскажет account).
4. Используйте `/create_invoice` для генерации адреса для оплаты, выбрав нужного покупателя.
5. Покупатель оплачивает инвойс на указанный адрес.
6. После поступления оплаты используйте `/sweep` для вывода средств и активации адреса.

Для полной смены кошелька покупателя используйте новый master wallet с новой seed-фразой и новый xPub.

## Лицензия

MIT
