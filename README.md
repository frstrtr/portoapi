
# PortoAPI

Многофункциональная платформа для приема криптоплатежей через Telegram-бота и API с поддержкой TRON, xPub, группировки инвойсов по покупателям.

## Архитектура
- **src/api/** — REST API (FastAPI), эндпоинты для инвойсов, вебхуков и регистрации.
- **src/bot/** — Telegram-бот на aiogram, FSM для создания инвойсов, обработка команд продавца.
- **src/core/** — бизнес-логика: HD Wallet, работа с БД (SQLAlchemy), сервисы газа и уведомлений.
- **src/services/** — keeper-бот для мониторинга блокчейна и автоматизации выплат.
- **src/static_web/** — offline-страницы для генерации xPub, безопасной настройки кошелька.

## Основные возможности
- Генерация и хранение xPub для TRON (BIP44, m/44'/195'/account').
- Группировка инвойсов по покупателям (buyer_id) у каждого продавца (seller_id).
- Автоматическая активация адресов и делегирование ресурсов (ENERGY/BANDWIDTH).
- Keeper-бот: мониторинг статуса инвойсов, автоматизация выплат.
- Безопасная регистрация через offline-страницу (setup.html/xpub_offline.html).

## Быстрый старт
1. Установите зависимости:
   ```bash
   pip install -r src/requirements.txt
   ```
2. Запустите API:
   ```bash
   uvicorn src.api.v1.main:app --reload
   ```
3. Запустите Telegram-бота:
   ```bash
   python src/bot/main_bot.py
   ```
4. Запустите keeper-бота:
   ```bash
   python src/services/keeper_bot.py
   ```

## Настройка кошелька продавца
- Перейдите на `/src/static_web/setup.html` или используйте `xpub_offline.html` для генерации xPub.
- Следуйте инструкциям на странице, сохраните seed-фразу, подтвердите и отправьте xPub на сервер.

## Структура БД (основное)
- sellers: telegram_id, ...
- buyer_groups: id, seller_id, buyer_id, invoices_group, xpub
- invoices: id, seller_id, buyer_group_id, ...
- wallets: id, telegram_id, buyer_group_id, invoices_group, xpub


## Безопасность

- Все операции с seed/xPub выполняются на клиенте (offline-страницы).
- Приватные ключи не передаются на сервер.


## Взаимодействие с Telegram-ботом

### Основные команды

- `/start` — Приветствие и главное меню с кнопками.
- `/help` — Список доступных команд.
- `/register` — Регистрация продавца, генерация токена и ссылки для настройки кошелька.
- `/deposit` — Показать баланс газового депозита продавца.
- `/balance` — Показать общий баланс продавца.
- `/create_invoice` — Пошаговое создание инвойса (через FSM: сумма, описание, выбор покупателя/группы).
- `/sweep` — Обработка всех оплаченных инвойсов, активация адресов, вывод средств.
- `/buyers` — Список всех покупателей и групп инвойсов продавца.
- `/add_buyer` — Добавить нового покупателя/группу для отдельного учета инвойсов.

#### Группы инвойсов и покупатели

Бот поддерживает создание групп инвойсов, привязанных к определённому покупателю (`buyer_id`) у каждого продавца (`seller_id`).
Это позволяет вести раздельный учёт поступлений и адресов для разных клиентов:

1. Используйте `/add_buyer` для создания новой группы (например, для постоянного покупателя или сегмента).
2. При создании инвойса через `/create_invoice` выберите нужного покупателя/группу.
3. Все адреса и поступления будут связаны с выбранной группой.
4. Для просмотра групп используйте `/buyers`.

### Как работать с ботом

1. Напишите `/start` — получите меню и инструкции.
2. Выполните `/register` — получите ссылку для настройки кошелька (setup.html).
3. После настройки кошелька используйте `/add_buyer` для создания группы (опционально).
4. Используйте `/create_invoice` для генерации адреса для оплаты, выбрав нужного покупателя/группу.
5. Покупатель оплачивает инвойс на указанный адрес.
6. После поступления оплаты используйте `/sweep` для вывода средств и активации адреса.


## Лицензия

MIT
