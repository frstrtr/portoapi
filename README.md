# PortoAPI

Многофункциональная платформа для приема криптоплатежей через Telegram-бота и API с поддержкой TRON, xPub, учёта покупателей и инвойсов.

## Архитектура
- **src/api/** — REST API (FastAPI), эндпоинты для инвойсов, вебхуков и регистрации.
- **src/bot/** — Telegram-бот на aiogram, FSM для создания инвойсов, обработка команд продавца, автоматическое управление аккаунтами и покупателями.
- **src/core/** — бизнес-логика: HD Wallet, работа с БД (SQLAlchemy), сервисы газа и уведомлений.
- **src/services/** — keeper-бот для мониторинга блокчейна и автоматизации выплат.
- **src/static_web/** — offline-страницы для генерации xPub, безопасной настройки кошелька.

## Основные возможности
- Генерация и хранение xPub для TRON (BIP44, m/44'/195'/account').
- Автоматическое назначение следующего свободного account при добавлении нового покупателя (buyer_id).
- Учёт инвойсов по покупателям (buyer_id) у каждого продавца (seller_id), account=0 всегда для default buyer.
- Сортировка списка покупателей по номеру аккаунта.
- Подсказка продавцу, какой account использовать при генерации xPub для нового покупателя.
- Возможность полностью сменить кошелёк покупателя, используя новый master wallet с новой seed-фразой (новый xPub).
- Автоматическая активация адресов и делегирование ресурсов (ENERGY/BANDWIDTH).
- Keeper-бот: мониторинг статуса инвойсов, автоматизация выплат.
- Безопасная регистрация через offline-страницу (setup.html/xpub_offline.html).
- Кнопочное главное меню и все основные действия через кнопки.
- Подробная команда /help с объяснением wallet/account/address index.
- Список инвойсов с отображением derivation path и всех деталей.
- FSM автоматически сбрасывается при вводе основной команды.

## Быстрый старт

### 1. Установите зависимости:
```bash
pip install -r src/requirements.txt
```

### 2. Настройте конфигурацию:
```bash
# Скопируйте шаблон конфигурации
cp .env.example .env

# Отредактируйте .env файл с вашими настройками
# См. docs/CONFIGURATION_GUIDE.md для подробной инструкции
```

### 3. Проверьте конфигурацию:
```bash
python scripts/validate_config.py
```

### 4. Для разработки сгенерируйте тестовый кошелёк:
```bash
python scripts/generate_test_wallet.py
```
pip install -r src/requirements.txt
```

### 2. Настройте конфигурацию:
```bash
# Скопируйте пример конфигурации
cp .env.example .env

# Отредактируйте .env файл с вашими настройками:
# - TELEGRAM_BOT_TOKEN (получите у @BotFather)
# - TRON_NETWORK (mainnet или testnet)
# - GAS_STATION_TYPE (single или multisig)
# - GAS_WALLET_PRIVATE_KEY или GAS_WALLET_MNEMONIC
```

### 3. Создайте директорию для базы данных:
```bash
mkdir -p data
```

### 4. Проверьте конфигурацию:
```bash
python scripts/validate_config.py
```

### 5. Запустите сервисы:

#### Telegram-бот:
```bash
python scripts/start.py bot
# или классический способ:
python -m src.bot.main_bot
```

#### API сервер:
```bash
python scripts/start.py api
# или:
uvicorn src.api.v1.main:app --reload
```

#### Keeper-бот (мониторинг блокчейна):
```bash
python scripts/start.py keeper
# или:
python -m src.services.keeper_bot
```

## Конфигурация

### Сеть TRON
Система поддерживает как mainnet, так и testnet TRON:

- **Testnet**: Для разработки и тестирования
- **Mainnet**: Для продакшена

### Gas Station (Активация адресов)

#### Режим Single Wallet
Использует один кошелек для всех операций активации:
```env
GAS_STATION_TYPE=single
GAS_WALLET_PRIVATE_KEY=your_private_key
# или
GAS_WALLET_MNEMONIC=your mnemonic phrase here
```

#### Режим Multisig (планируется)
Использует мультиподписной контракт:
```env
GAS_STATION_TYPE=multisig
MULTISIG_CONTRACT_ADDRESS=TMultiSigAddress
MULTISIG_REQUIRED_SIGNATURES=2
MULTISIG_OWNER_KEYS=key1,key2,key3
```

### Настройка ресурсов
Контролируйте количество TRX для операций:
```env
AUTO_ACTIVATION_TRX_AMOUNT=1.5    # Активация адреса
ENERGY_DELEGATION_TRX_AMOUNT=1.1  # Делегирование ENERGY  
BANDWIDTH_DELEGATION_TRX_AMOUNT=1.0 # Делегирование BANDWIDTH
```

## Настройка кошелька продавца
- Перейдите на `/src/static_web/setup.html` или используйте `xpub_offline.html` для генерации xPub.
- Следуйте инструкциям на странице, сохраните seed-фразу, подтвердите и отправьте xPub на сервер.
- Для каждого нового покупателя используйте новый account (номер будет показан ботом при добавлении).
- Для полной смены кошелька покупателя используйте новый master wallet с новой seed-фразой и новый xPub.

## Структура БД (основное)
- sellers: telegram_id, ...
- buyers: id, seller_id, buyer_id, account, xpub
- invoices: id, seller_id, buyer_id, ...
- wallets: id, telegram_id, buyer_id, account, xpub

## Безопасность
- Все операции с seed/xPub выполняются на клиенте (offline-страницы).
- Приватные ключи не передаются на сервер.

## Взаимодействие с Telegram-ботом

### Основные команды

- `/start` — Приветствие и главное меню с кнопками.
- `/help` — Список доступных команд и подробные объяснения wallet/account/address index.
- `/register` — Регистрация продавца, генерация токена и ссылки для настройки кошелька.
- `/deposit` — Показать баланс газового депозита продавца.
- `/balance` — Показать общий баланс продавца.
- `/create_invoice` — Пошаговое создание инвойса (через FSM: сумма, описание, выбор покупателя).
- `/sweep` — Обработка всех оплаченных инвойсов, активация адресов, вывод средств.
- `/buyers` — Список всех покупателей продавца, отсортирован по account.
- `/add_buyer` — Добавить нового покупателя для отдельного учета инвойсов, бот подскажет account.

#### Покупатели

Бот поддерживает создание покупателей (`buyer_id`) у каждого продавца (`seller_id`).
Это позволяет вести раздельный учёт поступлений и адресов для разных клиентов:

1. Используйте `/add_buyer` для создания нового покупателя (например, для постоянного клиента или сегмента). Бот покажет account для xPub.
2. При создании инвойса через `/create_invoice` выберите нужного покупателя.
3. Все адреса и поступления будут связаны с выбранным покупателем.
4. Для просмотра покупателей используйте `/buyers`.
- Для полной смены кошелька покупателя используйте новый master wallet с новой seed-фразой и новый xPub.

### Как работать с ботом

1. Напишите `/start` — получите меню и инструкции.
2. Выполните `/register` — получите ссылку для настройки кошелька (setup.html).
3. После настройки кошелька используйте `/add_buyer` для создания покупателя (бот подскажет account).
4. Используйте `/create_invoice` для генерации адреса для оплаты, выбрав нужного покупателя.
5. Покупатель оплачивает инвойс на указанный адрес.
6. После поступления оплаты используйте `/sweep` для вывода средств и активации адреса.
- Для полной смены кошелька покупателя используйте новый master wallet с новой seed-фразой и новый xPub.

## Лицензия

MIT
